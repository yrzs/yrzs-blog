---
title: "索引"
date: 2022-07-13T16:02:42+08:00
draft: false
---

在InnoDB中 [数据页](/post/2022/7/12/mysql-innodb) 有七个组成部分,各个数据页可以组成一个双向链表，
而每个数据页中的记录会按照主键值从小到大的顺序组成一个 _单向链表_ ,每个数据页都会为存储在它里边儿的数据生成一个 _页目录_ ，
在通过主键查找某条记录的时候可以在页目录中使用 _二分法_ 快速定位到对应的槽（slot）,然后遍历该slot对应分组中的记录即可快速找到指定的记录。

### 没有索引的查找

#### 在一个页中的查找
假设目前表中的记录比较少，所有的记录都可以被放到一个页中，在查找记录的时候可以根据搜索条件的不同分为两种情况：
 * 以主键为搜索条件
 >>> 在 _页目录_ 中使用 _二分法_ 快速定位到对应的slot... 
 * 以其他列作为搜索条件
 >>> 因为 _数据页_ 中并没有对非主键列建立所谓的 _页目录_ ，所以我们无法通过 _二分法_ 快速定位到相应的slot。
 >>> 这种情况下只能从 _最小记录_ 开始遍历单链表中的每条记录，然后对比每条记录是不是符合搜索条件。（效率非常低下）

#### 在很多页中查找
真实情况下表中存放的记录都是非常多的，需要很多数据页来存储这些记录，在很多页中查找记录可分为两个步骤：
 > 1. 定位到记录所在的页
 > 2. 从所在的页中查找相应的记录 

在没有索引的情况下，不论是根据主键列还是其他列进行查找，
<font color=orangeRed>由于我们并不能快速的定位到记录所在的页，所以只能从第一个页沿着双向链表一直往下找，在每一页中根据刚才所说的查找方式去查找置顶的记录。</font>
（非常耗时的操作）

### 索引

#### 一个简单的索引方案
我们在根据某个搜索条件查找一些记录时为什么要遍历所有的数据页呢？

<font color=orangeRed>因为各个页中的记录并没有规律，我们并不知道我们的搜索条件匹配哪些页的数据，所以不得不依次遍历所有数据页。</font>

所以如果 我们想快速的定位到需要查找的记录在哪些数据页中该咋办？还记得我们为根据主键值快速定位一条记录在页中的位
置而设立的页目录么？我们也可以想办法为快速定位记录所在的数据页而建立一个别的目录，建这个目录必须完成下边这些事儿：
 * 下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值（页分裂）
 * 给所有的页建立一个目录项
 >> _数据页的编号可能并不是连续的_， 因为这些16kb的页在物理存储上可能并不挨着，所以如果想从这么多页中根据主键值快速定位某些记录所在的页，
    我们需要给它们做个目录，<font color="orangeRed">每个页对应一个目录项</font>，其结构为：
    
>>>> * 页的用户记录中最小的主键值，用key表示
>>>> * 页号，page_no表示
![index_example](https://pic.rmb.bdstatic.com/bjh/339bac4eaf04e5068129f83960f32e7b.png)
>>>> 以 页28 为例，它对应 目录项2 ，这个目录项中包含着该页的页号 28 以及该页中用户记录的最小主键
     值 5 。我们只需要把几个目录项在物理存储器上连续存储，比如把他们放到一个数组里，就可以实现根
     据主键值快速查找某条记录的功能了。比方说我们想找主键值为 20 的记录，具体查找过程分两步：
>>>>  * 先从目录项中根据二分法快速确定出主键值为 20 的记录在 目录项3 中（因为 12 < 20 < 209 ），它对应的页是 _页9_ 
>>>>  * 再根据前边说的在页中查找记录的方式去 _页9_ 中定位具体的记录
 
至此，针对数据页做的简易目录就搞定了。 这个 _目录_ 就称为 _索引_

InnoDB 和 MyISAM 会自动为主键或
者声明为 UNIQUE 的列去自动建立 B+Tree 索引，但是如果我们想为其他的列建立索引就需要我们显式的去指明。为
啥不自动为每个列都建立个索引呢？别忘了，每建立一个索引都会建立一棵 B+Tree，每插入一条记录都要维护各
个记录、数据页的排序关系，这是很费性能和存储空间的。